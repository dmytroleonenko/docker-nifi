FROM       openjdk:alpine
MAINTAINER Dima Leonenko <dmitry.leonenko@gmail.com>
ARG        DIST_MIRROR=http://archive.apache.org/dist/nifi
ARG        VERSION=1.0.1
ENV        NIFI_HOME=/opt/nifi
RUN        apk update && apk add --upgrade curl && \
           adduser -h  ${NIFI_HOME} -g "Apache NiFi user" -s /bin/sh -D nifi && \
           mkdir -p ${NIFI_HOME}/logs \
           ${NIFI_HOME}/flowfile_repository \
           ${NIFI_HOME}/database_repository \
           ${NIFI_HOME}/content_repository \
           ${NIFI_HOME}/provenance_repository && \
           curl ${DIST_MIRROR}/${VERSION}/nifi-${VERSION}-bin.tar.gz | tar xvz -C ${NIFI_HOME} && \
           mv ${NIFI_HOME}/nifi-${VERSION}/* ${NIFI_HOME} && \
           rm -rf /var/cache/apk/*
COPY       docker-nifi/nifi-env.sh /exports/bin/nifi-env.sh
COPY       nifi-artifacts/lib /exports/lib
COPY       nifi-artifacts/resources /exports/resources
COPY       nifi-artifacts/conf /exports/conf
COPY       docker-nifi/start_nifi.sh /exports/start_nifi.sh
RUN        chown nifi:nifi -R $NIFI_HOME /exports
EXPORT     /opt/nifi
EXPORT     /exports/bin
EXPORT     /exports/lib
EXPORT     /exports/resources
EXPORT     /exports/conf
EXPORT     /exports/start_nifi.sh



FROM       openjdk:alpine
MAINTAINER Dima Leonenko <dmitry.leonenko@gmail.com>
ARG        VERSION=1.0.1
ENV        NIFI_HOME=/opt/nifi
RUN        apk update  && apk add --upgrade curl && \
           adduser -h  ${NIFI_HOME} -g "Apache NiFi user" -s /bin/sh -D nifi && \
           rm -rf /var/cache/apk/*
ADD        http://tn-alpine-repo.s3-website-us-east-1.amazonaws.com/-5838a3a8.rsa.pub /etc/apk/keys/
RUN        echo 'http://tn-alpine-repo.s3-website-us-east-1.amazonaws.com/' >>/etc/apk/repositories && apk add --update perl perl-app-cpanminus perl-archive-extract perl-archive-zip perl-b-hooks-endofscope perl-bit-vector perl-cam-pdf perl-carp-clan \
perl-class-singleton perl-clone perl-compress-raw-bzip2 perl-compress-raw-zlib perl-cpan-meta perl-cpan-meta-check perl-cpan-meta-requirements perl-cpan-meta-yaml \
perl-crypt-rc4 perl-date-calc perl-date-manip perl-datetime perl-datetime-locale perl-datetime-timezone perl-dbd-csv perl-dbi perl-digest-perl-md5 \
perl-dist-checkconflicts perl-encode-locale perl-file-listing perl-file-temp perl-html-parser perl-html-tagset perl-html-tree perl-http-cookies perl-http-daemon \
perl-http-date perl-http-message perl-http-negotiate perl-io-html perl-io-stringy perl-json-pp perl-list-allutils perl-list-someutils perl-list-someutils-xs \
perl-list-utilsby perl-lwp-mediatypes perl-math-base-convert perl-mime-base64 perl-module-build perl-module-implementation perl-module-load perl-module-load-conditional \
perl-module-metadata perl-module-runtime perl-namespace-autoclean perl-namespace-clean perl-net-http perl-number-format perl-ole-storage_lite perl-package-stash \
perl-package-stash-xs perl-params-util perl-params-validate perl-pathtools perl-scalar-list-utils perl-socket perl-spreadsheet-parseexcel perl-spreadsheet-xlsx \
perl-sql-statement perl-sub-exporter-progressive perl-sub-identify perl-sub-uplevel perl-super perl-test-deep perl-test-exception perl-test-fatal perl-test-harness \
perl-test-inter perl-test-leaktrace perl-test-mockmodule perl-test-nowarnings perl-test-requires perl-test-warnings perl-text-csv perl-text-csv_xs perl-text-parsewords \
perl-text-pdf perl-text-soundex perl-text-unidecode perl-time-hires perl-time-local perl-try-tiny perl-uri perl-variable-magic perl-www-robotrules perl-xml-parser ; rm -rf /var/cache/apk/*
VOLUME     ${NIFI_HOME}/logs \
           ${NIFI_HOME}/flowfile_repository \
           ${NIFI_HOME}/database_repository \
           ${NIFI_HOME}/content_repository \
           ${NIFI_HOME}/provenance_repository \
           /opt/datafiles \
           /opt/scriptfiles \
           /opt/certs
WORKDIR    ${NIFI_HOME}
EXPOSE     8080 8081 8443
WORKDIR    ${NIFI_HOME}
ENV        BANNER_TEXT=Docker-Nifi-${VERSION} \
           INSTANCE_ROLE=cluster-node \
           NODES_LIST=zoo-0.zk:2181,zoo-1.zk:2181,zoo-2.zk:2181 \
           MYID=N/A
IMPORT     nifi /opt
IMPORT     bin /opt/nifi
IMPORT     lib /opt/nifi
IMPORT     resources /opt/nifi
IMPORT     conf /opt/nifi
IMPORT     start_nifi.sh /opt/nifi
CMD        /bin/sh start_nifi.sh
TAG        nifi:latest
